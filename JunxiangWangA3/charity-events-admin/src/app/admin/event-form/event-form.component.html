<div class="container">
  <div class="header">
    <h2>{{ isEditMode ? "Edit Event" : "Create New Event" }}</h2>
    <button class="btn btn-secondary" (click)="goBack()">Back to Events</button>
  </div>

  <!-- 操作反馈消息 -->
  <div *ngIf="successMessage" class="alert alert-success mt-3">
    {{ successMessage }}
  </div>
  
  <div *ngIf="error" class="alert alert-danger mt-3">
    {{ error }}
  </div>

  <form [formGroup]="eventForm" (ngSubmit)="onSubmit()" class="form mt-4">
    <!-- 活动标题 -->
    <div class="form-group">
      <label for="title" class="form-label">Event Title *</label>
      <input type="text" id="title" formControlName="title" class="form-control">
      <div *ngIf="eventForm.get('title')?.invalid && (eventForm.get('title')?.touched || eventForm.get('title')?.dirty)" class="text-danger small">
        <div *ngIf="eventForm.get('title')?.errors?.['required']">Title is required.</div>
        <div *ngIf="eventForm.get('title')?.errors?.['minlength']">Title must be at least 3 characters.</div>
      </div>
    </div>

    <!-- 活动描述 -->
    <div class="form-group">
      <label for="description" class="form-label">Description</label>
      <textarea id="description" formControlName="description" class="form-control" rows="4"></textarea>
    </div>

    <!-- 日期区间 -->
    <div class="form-row d-flex gap-3">
      <div class="form-group flex-grow-1">
        <label for="start_date" class="form-label">Start Date *</label>
        <input type="datetime-local" id="start_date" formControlName="start_date" class="form-control">
        <div *ngIf="eventForm.get('start_date')?.invalid && (eventForm.get('start_date')?.touched || eventForm.get('start_date')?.dirty)" class="text-danger small">
          Start date is required.
        </div>
      </div>

      <div class="form-group flex-grow-1">
        <label for="end_date" class="form-label">End Date *</label>
        <input type="datetime-local" id="end_date" formControlName="end_date" class="form-control">
        <div *ngIf="eventForm.get('end_date')?.invalid && (eventForm.get('end_date')?.touched || eventForm.get('end_date')?.dirty)" class="text-danger small">
          End date is required.
        </div>
      </div>
    </div>

    <!-- 活动地点 -->
    <div class="form-group">
      <label for="location" class="form-label">Location *</label>
      <input type="text" id="location" formControlName="location" class="form-control">
      <div *ngIf="eventForm.get('location')?.invalid && (eventForm.get('location')?.touched || eventForm.get('location')?.dirty)" class="text-danger small">
        Location is required.
      </div>
    </div>

    <!-- 分类与票数 -->
    <div class="form-row d-flex gap-3">
      <div class="form-group flex-grow-1">
        <label for="category_id" class="form-label">Category ID *</label>
        <input type="number" id="category_id" formControlName="category_id" class="form-control" min="1">
        <div *ngIf="eventForm.get('category_id')?.invalid && (eventForm.get('category_id')?.touched || eventForm.get('category_id')?.dirty)" class="text-danger small">
          Valid category ID (positive number) is required.
        </div>
      </div>

      <div class="form-group flex-grow-1">
        <label for="max_tickets" class="form-label">Max Tickets *</label>
        <input type="number" id="max_tickets" formControlName="max_tickets" class="form-control" min="1">
        <div *ngIf="eventForm.get('max_tickets')?.invalid && (eventForm.get('max_tickets')?.touched || eventForm.get('max_tickets')?.dirty)" class="text-danger small">
          At least 1 ticket is required.
        </div>
      </div>
    </div>

    <!-- 表单操作按钮 -->
    <div class="form-actions d-flex justify-content-end gap-2 mt-4">
      <button type="button" class="btn btn-secondary" (click)="goBack()">Cancel</button>
      <button type="submit" class="btn btn-primary" [disabled]="eventForm.invalid || loading">
        {{ loading ? 'Saving...' : (isEditMode ? 'Update Event' : 'Create Event') }}
      </button>
    </div>
  </form>

  <!-- 编辑模式下的报名信息（若有） -->
  <div *ngIf="isEditMode && registrations.length > 0" class="registrations mt-5">
    <h3 class="mb-3">Event Registrations</h3>
    <div class="stats d-flex justify-content-between mb-3">
      <div class="stat">
        <strong>{{ registrations.length }}</strong> Total Registrations
      </div>
      <div class="stat">
        <strong>{{ getTotalTickets() }}</strong> Tickets Booked
      </div>
    </div>
    
    <table class="table table-striped table-hover">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Tickets</th>
          <th>Registration Date</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let reg of registrations">
          <td>{{ reg.user_name }}</td>
          <td>{{ reg.user_email }}</td>
          <td>{{ reg.ticket_count }}</td>
          <td>{{ reg.registration_date | date:'short' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>